<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelas Digital: Portal Tugas Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font baru: Cormorant Garamond & Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Impor Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Latar belakang animasi gradasi lilac */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #ede9fe, #ddd6fe, #c4b5fd, #a78bfa);
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Mengaplikasikan font baru */
        body, h1, h2, h3, button, select {
            font-family: 'Cormorant Garamond', serif;
        }
        /* Menggunakan font Poppins untuk teks deskripsi agar mudah dibaca */
        p, td, th, label, textarea, input, span, a {
            font-family: 'Poppins', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        /* Animasi untuk Modal dan Notifikasi */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }

        @keyframes fade-in-down {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out-up {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); visibility: hidden; }
        }
        .animate-fade-in-down { animation: fade-in-down 0.5s ease-out forwards; }
        .animate-fade-out-up { animation: fade-out-up 0.5s ease-out forwards; }
    </style>
</head>
<body class="text-gray-800">
    
    <div class="animated-bg"></div>

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Konten aplikasi akan dirender di sini oleh JavaScript -->
    </div>

    <!-- Container untuk Modal -->
    <div id="modal-container" class="hidden fixed inset-0 z-50"></div>
    
    <!-- Container untuk Notifikasi Toast -->
    <div id="notification-container" class="fixed top-5 right-5 z-[100] w-full max-w-xs sm:max-w-sm"></div>

    <!-- Modal Manajemen Pengguna (khusus admin) -->
    <div id="user-modal" class="hidden fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg animate-fade-in-up">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="user-modal-title" class="text-2xl font-bold">Tambah Pengguna</h3>
                <button data-action="close-user-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="user-form">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="user-id">
                    <div>
                        <label for="user-nama" class="block mb-1 font-medium">Nama Lengkap</label>
                        <input type="text" id="user-nama" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="user-username" class="block mb-1 font-medium">Username</label>
                        <input type="text" id="user-username" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="user-password" class="block mb-1 font-medium">Password</label>
                        <input type="password" id="user-password" class="w-full p-2 border rounded-md">
                        <p id="password-hint" class="text-xs text-gray-500 mt-1">Kosongkan jika tidak ingin mengubah password.</p>
                    </div>
                    <div>
                        <label for="user-role" class="block mb-1 font-medium">Peran</label>
                        <select id="user-role" class="w-full p-2 border rounded-md bg-white">
                            <option value="siswa">Siswa</option>
                            <option value="guru">Guru</option>
                        </select>
                    </div>
                    <p id="user-error" class="text-red-500 text-sm hidden"></p>
                </div>
                <div class="flex justify-end p-4 bg-gray-50 border-t rounded-b-lg">
                   <button type="button" data-action="close-user-modal" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                   <button type="submit" class="bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================================
            // KONFIGURASI SUPABASE (GANTI DENGAN KUNCI ANDA)
            // =================================================================================
            const SUPABASE_URL = 'https://ohluflprnebfsescgryg.supabase.co'; // <-- GANTI DENGAN URL ANDA
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9obHVmbHBybmViZnNlc2NncnlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODQ5MDgsImV4cCI6MjA3NjY2MDkwOH0.F2a_P9zSoRGaiep0qSe22qVqvFSnajFZ7OzYRl13Qts'; // <-- GANTI DENGAN KUNCI ANON ANDA

            const appContainer = document.getElementById('app');
            
            // Cek apakah kredensial sudah diisi
            if (SUPABASE_URL === 'URL_ANDA_DARI_SUPABASE' || SUPABASE_ANON_KEY === 'KUNCI_ANON_ANDA_DARI_SUPABASE') {
                appContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg max-w-2xl mx-auto mt-10 animate-fade-in-up">
                    <h2 class="font-bold text-xl mb-2">Konfigurasi Database Diperlukan!</h2>
                    <p class="font-sans">Anda harus mengedit file <strong>index.html</strong> ini.</p>
                    <p class="font-sans mt-2">Salin <code>URL</code> dan <code>Kunci ANON</code> dari proyek Supabase Anda dan tempelkan ke variabel <strong>SUPABASE_URL</strong> dan <strong>SUPABASE_ANON_KEY</strong> di baris atas tag script.</p>
                    <p class="font-sans mt-2">Silakan ikuti panduan di file <strong>panduan_supabase.md</strong> untuk mendapatkannya.</p>
                </div>`;
                return; // Menghentikan eksekusi skrip jika belum dikonfigurasi
            }

            // Inisialisasi Supabase Client
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


            // =================================================================================
            // STATE & DATA MANAGEMENT
            // =================================================================================
            // State sekarang hanya menyimpan data sesi. Data utama akan diambil dari Supabase.
            let state = {
                currentUserRole: null, 
                currentUserName: null, 
                currentUserId: null,
                selectedSubject: 'Semua', // <-- STATE BARU: Digunakan untuk filter tab Guru
                users: {
                    superadmin: [],
                    guru: [],
                    siswa: []
                },
                tugas: [],
                pengumpulan: []
            };

            const modalContainer = document.getElementById('modal-container');
            const userModal = document.getElementById('user-modal');
            const userForm = document.getElementById('user-form');
            const userModalTitle = document.getElementById('user-modal-title');
            const userError = document.getElementById('user-error');
            const passwordHint = document.getElementById('password-hint');

            // Daftar mata pelajaran
            const MATA_PELAJARAN_LIST = [
                'Informatika', 'Biologi', 'Ekonomi', 'Matematika', 
                'Bahasa Indonesia', 'Bahasa Inggris', 'Bahasa Sunda', 'Seni Budaya', 'Lainnya'
            ];

            // =================================================================================
            // HELPER FUNCTIONS
            // =================================================================================
            const formatDate = (date) => {
                if (!date || isNaN(new Date(date))) return 'Invalid Date';
                return new Intl.DateTimeFormat('id-ID', {
                    day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                }).format(new Date(date));
            };
            
            const toDateTimeLocal = (date) => {
                const dt = new Date(date);
                dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
                return dt.toISOString().slice(0, 16);
            };

            const getStatusTugas = (tugas, pengumpulan) => {
                const now = new Date();
                if (pengumpulan) {
                    return { text: 'Terkumpul', color: 'violet', icon: 'fa-check-circle' };
                }
                if (now > new Date(tugas.deadline)) {
                    return { text: 'Terlambat', color: 'red', icon: 'fa-times-circle' };
                }
                return { text: 'Belum Dikumpulkan', color: 'gray', icon: 'fa-clock' };
            };
            
            const getStatusPengumpulan = (pengumpulan, tugas) => {
                 if (new Date(pengumpulan.tanggalKumpul) <= new Date(tugas.deadline)) {
                     return { text: 'Tepat Waktu', color: 'green' };
                 }
                 return { text: 'Terlambat', color: 'red' };
            }

            const showNotification = (message, type = 'success') => {
                const container = document.getElementById('notification-container');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

                const toast = document.createElement('div');
                toast.className = `p-4 rounded-lg shadow-lg text-white ${bgColor} animate-fade-in-down mb-2 flex items-center`;
                toast.innerHTML = `<i class="fas ${icon} mr-3"></i> <span class="font-sans">${message}</span>`;

                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('animate-fade-in-down');
                    toast.classList.add('animate-fade-out-up');
                    toast.addEventListener('animationend', () => toast.remove());
                }, 3000);
            };
            
            // saveState sekarang HANYA menyimpan info login (sesi)
            const saveState = () => {
                const sessionData = {
                    currentUserRole: state.currentUserRole,
                    currentUserName: state.currentUserName,
                    currentUserId: state.currentUserId
                };
                localStorage.setItem('kelasDigitalSession', JSON.stringify(sessionData));
            };

            // loadState sekarang HANYA memuat info login (sesi)
            const loadState = () => {
                const savedSession = localStorage.getItem('kelasDigitalSession');
                if (savedSession) {
                    const parsedSession = JSON.parse(savedSession);
                    Object.assign(state, parsedSession);
                }
            };

            // Fungsi BARU untuk memuat semua data dari Supabase
            const loadDataFromSupabase = async () => {
                // Tampilkan loader
                appContainer.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-4xl text-violet-600"></i><p class="font-sans text-lg mt-2">Memuat data dari database...</p></div>`;

                try {
                    // 1. Ambil data users
                    const { data: usersData, error: usersError } = await supabase.from('users').select('*');
                    if (usersError) throw usersError;

                    // 2. Ambil data tugas
                    const { data: tugasData, error: tugasError } = await supabase.from('tugas').select('*');
                    if (tugasError) throw tugasError;

                    // 3. Ambil data pengumpulan
                    const { data: pengumpulanData, error: pengumpulanError } = await supabase.from('pengumpulan').select('*');
                    if (pengumpulanError) throw pengumpulanError;

                    // Proses dan masukkan data ke 'state' lokal
                    state.users = { superadmin: [], guru: [], siswa: [] };
                    usersData.forEach(user => {
                        if (state.users[user.role]) {
                            state.users[user.role].push(user);
                        }
                    });

                    state.tugas = tugasData.map(t => ({
                        ...t,
                        deadline: new Date(t.deadline) // Ubah string timestamp menjadi objek Date
                    })).sort((a, b) => b.deadline - a.deadline); // Urutkan tugas terbaru di atas

                    state.pengumpulan = pengumpulanData.map(p => ({
                        ...p,
                        tanggalKumpul: new Date(p.tanggalKumpul), // Ubah string timestamp menjadi objek Date
                        file: { name: p.file_name, size: p.file_size, path: p.file_path } // Rekonstruksi objek file
                    }));
                    
                    return true; // Sukses

                } catch (error) {
                    console.error('Error loading data from Supabase:', error.message);
                    appContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg max-w-2xl mx-auto mt-10 animate-fade-in-up">
                        <h2 class="font-bold text-xl mb-2">Error Terhubung ke Database!</h2>
                        <p class="font-sans">Gagal memuat data dari Supabase. Pesan error: ${error.message}</p>
                        <p class="font-sans mt-2">Pastikan URL dan Kunci Anon Anda benar, dan Anda telah mengikuti panduan di <strong>panduan_supabase.md</strong> untuk mengatur tabel dan RLS.</p>
                    </div>`;
                    return false; // Gagal
                }
            };


            // =================================================================================
            // RENDER FUNCTIONS (UI COMPONENTS)
            // =================================================================================
            const renderLogin = () => {
                appContainer.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="bg-white/80 backdrop-blur-sm p-8 rounded-xl shadow-lg w-full max-w-md text-center animate-fade-in-up">
                            <i class="fas fa-book-reader text-5xl text-violet-600 mb-4"></i>
                            <h1 class="text-4xl font-bold mb-2">Kelas Digital</h1>
                            <p class="text-gray-600 mb-6 text-base">Portal Tugas Modern. Silakan masuk.</p>
                            <div class="space-y-4 text-left">
                                <div>
                                    <label for="username" class="block mb-1 text-lg font-medium">Username</label>
                                    <input type="text" id="username" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-base" placeholder="Masukkan username">
                                </div>
                                <div>
                                    <label for="password" class="block mb-1 text-lg font-medium">Password</label>
                                    <input type="password" id="password" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-base" placeholder="Masukkan password">
                                </div>
                                <div>
                                    <label for="roleSelector" class="block mb-1 text-lg font-medium">Masuk sebagai</label>
                                    <select id="roleSelector" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-lg bg-white">
                                        <option value="siswa">Siswa</option>
                                        <option value="guru">Guru</option>
                                        <option value="superadmin">Super Admin</option>
                                    </select>
                                </div>
                            </div>
                            <p id="loginError" class="text-red-500 text-sm mt-4 hidden"></p>
                            <button id="loginBtn" class="w-full mt-6 bg-violet-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-violet-700 transition duration-300 text-xl">
                                Masuk
                            </button>
                        </div>
                    </div>
                `;
                // Attach login button listener specifically when login page is rendered
                document.getElementById('loginBtn')?.addEventListener('click', handleLogin);
            };
            
            const renderSuperAdminDashboard = () => {
                // Bagian manajemen pengguna
                const managedUsers = [...(state.users.guru || []), ...(state.users.siswa || [])]
                    .sort((a, b) => a.nama.localeCompare(b.nama)) // Urutkan berdasarkan nama
                    .map(user => `
                        <tr class="border-b">
                            <td class="p-3">${user.nama}</td>
                            <td class="p-3">${user.username}</td>
                            <td class="p-3 capitalize">${user.role}</td>
                            <td class="p-3 text-right">
                                <button data-action="edit-user" data-id="${user.id}" class="bg-yellow-500 text-white px-2 py-1 rounded-lg text-xs hover:bg-yellow-600 mr-2"><i class="fas fa-edit"></i></button>
                                <button data-action="delete-user" data-id="${user.id}" data-nama="${user.nama}" class="bg-red-500 text-white px-2 py-1 rounded-lg text-xs hover:bg-red-600"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('');

                appContainer.innerHTML = `
                    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg animate-fade-in-up">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                            <div>
                                <h1 class="text-4xl font-bold">Dashboard Super Admin</h1>
                                <p class="text-gray-500">Selamat datang, ${state.currentUserName}!</p>
                            </div>
                            <button data-action="logout" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition text-lg">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>

                        <!-- Manajemen Pengguna -->
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                               <h2 class="text-3xl font-semibold border-b pb-2">Manajemen Pengguna</h2>
                               <button data-action="add-user" class="bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700 transition text-lg">
                                   <i class="fas fa-plus mr-2"></i>Tambah Pengguna
                               </button>
                            </div>
                            
                             <h3 class="text-xl font-semibold mt-6 mb-3 text-gray-700">Daftar Pengguna Aktif</h3>
                             <div class="overflow-x-auto rounded-lg border">
                                 <table class="min-w-full bg-white">
                                     <thead class="bg-gray-200">
                                         <tr>
                                             <th class="p-3 text-left font-semibold">Nama</th>
                                             <th class="p-3 text-left font-semibold">Username</th>
                                             <th class="p-3 text-left font-semibold">Peran</th>
                                             <th class="p-3 text-right font-semibold">Aksi</th>
                                         </tr>
                                     </thead>
                                     <tbody>${managedUsers.length > 0 ? managedUsers : '<tr><td colspan="4" class="text-center p-4 text-gray-500">Belum ada pengguna aktif.</td></tr>'}</tbody>
                                 </table>
                             </div>
                        </div>
                    </div>
                `;
            };

            const renderGuruDashboard = () => {
                // Logika untuk "Tugas Terkumpul" - DIUBAH UNTUK PENGELOMPOKAN & FILTER
                let submissionsHtml = ''; // Ini akan menampung semua HTML untuk tugas terkumpul
                
                const submissionsBySubject = {};
                MATA_PELAJARAN_LIST.forEach(subject => {
                    submissionsBySubject[subject] = [];
                });

                let hasSubmissions = false;
                
                // Urutkan berdasarkan tanggal terlebih dahulu
                const sortedSubmissions = [...state.pengumpulan].sort((a, b) => b.tanggalKumpul - a.tanggalKumpul);

                sortedSubmissions.forEach(p => {
                    const tugas = state.tugas.find(t => t.id === p.tugasId);
                    if (!tugas) return; // Lewati jika tugas tidak ditemukan
                    // Tentukan mata pelajaran (fallback ke 'Lainnya')
                    const subject = tugas.mata_pelajaran && MATA_PELAJARAN_LIST.includes(tugas.mata_pelajaran) ? tugas.mata_pelajaran : 'Lainnya';
                    submissionsBySubject[subject].push(p);
                    hasSubmissions = true;
                });

                // --- LOGIKA BARU UNTUK MEMBUAT TOMBOL TAB ---
                const subjectsWithSubmissions = ['Semua'];
                // Tambahkan subjek hanya jika ada tugas terkumpul di dalamnya
                MATA_PELAJARAN_LIST.forEach(subject => {
                    if (submissionsBySubject[subject].length > 0) {
                        subjectsWithSubmissions.push(subject);
                    }
                });

                const tabsHtml = subjectsWithSubmissions.map(subject => {
                    const isActive = state.selectedSubject === subject;
                    // Styling untuk tab aktif/tidak aktif
                    const activeClass = isActive ? 'bg-violet-600 text-white shadow-lg' : 'bg-white text-violet-700 hover:bg-violet-100 border border-violet-200';
                    return `<button data-action="select-subject-tab" data-subject="${subject}" class="font-sans font-medium py-2 px-4 rounded-lg transition ${activeClass}">
                                ${subject}
                            </button>`;
                }).join('');
                // --- AKHIR LOGIKA TAB ---


                // Buat HTML-nya
                submissionsHtml += `<h2 class="text-3xl font-semibold mb-4">Tugas Terkumpul</h2>`; // Header utama
                
                // --- TAMBAHKAN TOMBOL TAB KE HTML ---
                submissionsHtml += `<div class="flex flex-wrap gap-2 mb-6 p-2 bg-gray-50 rounded-lg shadow-inner">${tabsHtml}</div>`;


                if (!hasSubmissions) {
                    submissionsHtml += '<p class="text-center p-4">Belum ada tugas yang dikumpulkan.</p>';
                } else {
                    // --- MODIFIKASI: Tentukan mata pelajaran mana yang akan ditampilkan ---
                    const subjectsToShow = state.selectedSubject === 'Semua' 
                        ? MATA_PELAJARAN_LIST // Jika 'Semua', tampilkan semua
                        : [state.selectedSubject]; // Jika tidak, tampilkan hanya yang dipilih

                    let foundAnyInFilter = false; // Untuk cek apakah filter menghasilkan sesuatu

                    for (const subject of subjectsToShow) {
                        const subjectSubmissions = submissionsBySubject[subject];
                        if (subjectSubmissions.length > 0) {
                            foundAnyInFilter = true; // Ditemukan
                            
                            // Tambahkan header mata pelajaran, tapi hanya jika BUKAN filter satu subjek
                            if (state.selectedSubject === 'Semua') {
                                submissionsHtml += `<h3 class="text-2xl font-semibold text-gray-700 mt-6 mb-3">${subject}</h3>`;
                            }

                            // Tambahkan tabel untuk mata pelajaran ini
                            submissionsHtml += `
                                <div class="overflow-x-auto rounded-lg border">
                                    <table class="min-w-full bg-white">
                                        <thead class="bg-gray-200">
                                            <tr>
                                                <th class="p-4 text-left font-semibold text-base">Nama Siswa</th>
                                                <th class="p-4 text-left font-semibold text-base">Tugas</th>
                                                <th class="p-4 text-left font-semibold text-base">File</th>
                                                <th class="p-4 text-left font-semibold text-base">Tanggal Kumpul</th>
                                                <th class="p-4 text-left font-semibold text-base">Status</th>
                                                <th class="p-4 text-left font-semibold text-base">Nilai</th>
                                                <th class="p-4 text-left font-semibold text-base">Komentar</th>
                                                <th class="p-4 text-left font-semibold text-base">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;

                            // Tambahkan baris-baris (tugas) untuk mata pelajaran ini
                            submissionsHtml += subjectSubmissions.map(p => {
                                const tugas = state.tugas.find(t => t.id === p.tugasId); // Cari lagi (aman)
                                if (!tugas) return ''; // Pengecekan keamanan
                                const status = getStatusPengumpulan(p, tugas);
                                const isLate = status.text === 'Terlambat';
                                const rowClass = isLate ? 'bg-red-50/50' : 'bg-green-50/50';
                                // PERBAIKAN: Tambahkan pengecekan apakah file dan file.path ada
                                const hasFile = p.file && p.file.path;

                                return `
                                    <tr class="border-b hover:bg-gray-50 ${rowClass}">
                                        <td class="p-4">${p.namaSiswa}</td>
                                        <td class="p-4">${tugas.judul}</td>
                                        <td class="p-4">
                                            ${hasFile ? `
                                            <a data-action="lihat-tugas" data-id="${p.id}" class="text-violet-600 hover:underline cursor-pointer font-medium">
                                                <i class="fas fa-file-alt mr-1"></i>${p.file.name}
                                            </a>
                                            ` : `
                                            <span class="text-gray-400 italic">File tidak ada</span>
                                            `}
                                        </td>
                                        <td class="p-4">${formatDate(p.tanggalKumpul)}</td>
                                        <td class="p-4 font-medium text-${status.color}-600">${status.text}</td>
                                        <td class="p-4">
                                            <input type="number" data-id="${p.id}" value="${p.nilai || ''}" placeholder="0-100" class="w-20 p-1 border rounded nilai-input">
                                        </td>
                                        <td class="p-4">
                                            <textarea data-id="${p.id}" placeholder="Beri komentar..." class="w-full p-1 border rounded komentar-input">${p.komentarGuru || ''}</textarea>
                                        </td>
                                        <td class="p-4">
                                            <button data-action="simpan-penilaian" data-id="${p.id}" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600">Simpan</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('');

                            // Tutup tabel
                            submissionsHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }
                    }

                    // Jika filter aktif tapi tidak ada hasil
                    if (!foundAnyInFilter && state.selectedSubject !== 'Semua') {
                        submissionsHtml += `<p class="font-sans text-center p-4 text-gray-500">Tidak ada tugas terkumpul untuk mata pelajaran <strong>${state.selectedSubject}</strong>.</p>`;
                    }
                }
                // AKHIR DARI BLOK LOGIKA PENGELOMPOKAN & FILTER


                appContainer.innerHTML = `
                    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg animate-fade-in-up">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                            <div>
                                <h1 class="text-4xl font-bold">Dashboard Guru</h1>
                                <p class="text-gray-500">Selamat datang, ${state.currentUserName}! Anda dapat memeriksa tugas siswa di sini.</p>
                            </div>
                            <button data-action="logout" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition text-lg">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>
                        
                        <div class="mb-6">
                             <button data-action="tambah-tugas" class="bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700 transition text-lg">
                                 <i class="fas fa-plus mr-2"></i>Tambah Tugas Baru
                             </button>
                        </div>

                        <!-- BARU: Daftar Tugas yang Diberikan -->
                        <div class="mb-8">
                            <h2 class="text-3xl font-semibold mb-4">Daftar Tugas Diberikan</h2>
                            <div class="overflow-x-auto rounded-lg border">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-4 text-left font-semibold text-base">Judul Tugas</th>
                                            <th class="p-4 text-left font-semibold text-base">Mata Pelajaran</th>
                                            <th class="p-4 text-left font-semibold text-base">Deadline</th>
                                            <th class="p-4 text-left font-semibold text-base">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${state.tugas.length > 0 ? state.tugas.map(tugas => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="p-4">${tugas.judul}</td>
                                                <td class="p-4">${tugas.mata_pelajaran || 'Umum'}</td>
                                                <td class="p-4">${formatDate(tugas.deadline)}</td>
                                                <td class="p-4">
                                                    <button data-action="edit-tugas" data-id="${tugas.id}" class="bg-yellow-500 text-white px-2 py-1 rounded-lg text-sm hover:bg-yellow-600 mr-2"><i class="fas fa-edit"></i> Edit</button>
                                                    <button data-action="delete-tugas" data-id="${tugas.id}" data-judul="${tugas.judul}" class="bg-red-500 text-white px-2 py-1 rounded-lg text-sm hover:bg-red-600"><i class="fas fa-trash"></i> Hapus</button>
                                                </td>
                                            </tr>
                                        `).join('') : '<tr><td colspan="4" class="text-center p-4">Belum ada tugas yang dibuat.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- TUGAS TERKUMPUL SEKARANG DI-RENDER MENGGUNAKAN LOGIKA BARU DENGAN TAB FILTER -->
                        ${submissionsHtml}
                        
                    </div>
                `;
            };

            const renderSiswaDashboard = () => {
                // Logika pengelompokan tugas berdasarkan mata pelajaran
                const tugasBySubject = {};
                MATA_PELAJARAN_LIST.forEach(subject => {
                    tugasBySubject[subject] = [];
                });

                state.tugas.forEach(tugas => {
                    // Gunakan 'Lainnya' jika mata pelajaran null atau tidak ada di daftar
                    const subject = tugas.mata_pelajaran && MATA_PELAJARAN_LIST.includes(tugas.mata_pelajaran) ? tugas.mata_pelajaran : 'Lainnya';
                    if (!tugasBySubject[subject]) {
                        tugasBySubject[subject] = []; // Safety net
                    }
                    tugasBySubject[subject].push(tugas);
                });

                let tugasHtml = '';
                let hasTugas = false;

                // Render setiap grup mata pelajaran
                for (const subject of MATA_PELAJARAN_LIST) {
                    const tugasList = tugasBySubject[subject];
                    if (tugasList.length > 0) {
                        hasTugas = true;
                        // Tambahkan header untuk mata pelajaran
                        tugasHtml += `<h3 class="text-2xl font-semibold text-gray-700 mt-6 mb-3">${subject}</h3>`;
                        
                        // Render kartu tugas untuk mata pelajaran ini
                        tugasHtml += tugasList.map(tugas => {
                            const pengumpulan = state.pengumpulan.find(p => p.tugasId === tugas.id && p.siswaId === state.currentUserId);
                            const status = getStatusTugas(tugas, pengumpulan);

                            return `
                                <div class="bg-white/80 backdrop-blur-sm p-6 rounded-lg shadow transition hover:shadow-xl hover:-translate-y-1">
                                    <div class="flex flex-wrap justify-between items-start gap-2">
                                        <div>
                                            <h3 class="text-2xl font-bold text-violet-700">${tugas.judul}</h3>
                                            <p class="text-sm text-red-600 font-semibold mb-2">
                                                <i class="fas fa-calendar-times mr-1"></i> Deadline: ${formatDate(new Date(tugas.deadline))}
                                            </p>
                                            <p class="text-gray-600 mb-4">${tugas.deskripsi}</p>
                                        </div>
                                        <span class="text-sm font-medium text-${status.color}-600 bg-${status.color}-100 px-3 py-1 rounded-full whitespace-nowrap">
                                            <i class="fas ${status.icon} mr-1"></i>
                                            ${status.text}
                                        </span>
                                    </div>
                                    
                                    ${pengumpulan ? `
                                        <div class="mt-4 border-t pt-4">
                                            <p class="font-semibold text-base">Tugas Anda:</p>
                                            <div class="flex items-center text-gray-700 bg-gray-100 p-2 rounded-md mt-2">
                                                <i class="fas fa-file-alt text-lg mr-3"></i>
                                                <!-- PERBAIKAN: Tambahkan pengecekan apakah file dan file.path ada -->
                                                ${(pengumpulan.file && pengumpulan.file.path) ? `
                                                <a data-action="lihat-tugas" data-id="${pengumpulan.id}" class="text-violet-600 hover:underline cursor-pointer font-medium">
                                                    ${pengumpulan.file.name}
                                                </a>
                                                ` : `
                                                <span class="text-gray-400 italic">File tidak ada</span>
                                                `}
                                            </div>
                                            ${pengumpulan.nilai !== null ? `
                                                <div class="mt-3">
                                                    <p class="font-semibold text-base">Nilai: <span class="text-2xl font-bold text-green-600">${pengumpulan.nilai}</span></p>
                                                </div>
                                                <div class="mt-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md">
                                                    <p class="font-bold text-base">Komentar dari Guru:</p>
                                                    <p>${pengumpulan.komentarGuru || '<i>Belum ada komentar.</i>'}</p>
                                                </div>
                                            ` : `
                                                <p class="mt-3 text-sm text-gray-500">Tugas Anda sedang diperiksa oleh guru.</p>
                                            `}
                                        </div>
                                    ` : `
                                        <button data-action="kumpul-tugas" data-id="${tugas.id}" class="mt-4 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed text-lg"
                                            ${new Date() > new Date(tugas.deadline) ? 'disabled' : ''}>
                                            <i class="fas fa-upload mr-2"></i>${new Date() > new Date(tugas.deadline) ? 'Waktu Habis' : 'Kumpulkan Tugas'}
                                        </button>
                                    `}
                                </div>
                            `;
                        }).join('<div class="my-2"></div>'); // Spasi kecil antar kartu
                    }
                }

                appContainer.innerHTML = `
                    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg animate-fade-in-up">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                            <div>
                                <h1 class="text-4xl font-bold">Dashboard Siswa</h1>
                                <p class="text-gray-500">Selamat datang, ${state.currentUserName}!</p>
                            </div>
                            <button data-action="logout" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition text-lg">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>
                        <h2 class="text-3xl font-semibold mb-4">Daftar Tugas</h2>
                        <div>
                            ${hasTugas ? tugasHtml : '<p>Belum ada tugas yang diberikan.</p>'}
                        </div>
                    </div>
                `;
            };
            
            const renderModal = ({ title, body, footer }) => {
                modalContainer.innerHTML = `
                    <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg animate-fade-in-up">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="text-2xl font-bold">${title}</h3>
                                <!-- PERBAIKAN: Mengganti data-action with onclick untuk keandalan -->
                                <button onclick="closeAppModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                            </div>
                            <div class="p-6 space-y-4">
                                ${body}
                            </div>
                            <div class="flex justify-end p-4 bg-gray-50 border-t rounded-b-lg">
                                ${footer}
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.classList.remove('hidden');
            };

            // =================================================================================
            // MODAL & RENDER HELPER FUNCTIONS
            // =================================================================================
            const showModal = (config) => renderModal(config);
            const closeModal = () => {
                modalContainer.classList.add('hidden');
                modalContainer.innerHTML = '';
            };

            // FUNGSI BARU: Fungsi global untuk menutup modal, dipanggil oleh onclick
            window.closeAppModal = () => {
                closeModal();
            };

            const showUserModal = (user = null) => {
                userForm.reset();
                userError.classList.add('hidden');
                document.getElementById('user-id').value = '';
                
                if (user) {
                    userModalTitle.textContent = 'Edit Pengguna';
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-nama').value = user.nama;
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-role').value = user.role;
                    document.getElementById('user-password').placeholder = "Kosongkan jika tidak berubah";
                    passwordHint.classList.remove('hidden');
                } else {
                    userModalTitle.textContent = 'Tambah Pengguna';
                    document.getElementById('user-password').placeholder = "Password (wajib diisi)";
                    passwordHint.classList.add('hidden');
                }
                userModal.classList.add('flex');
                userModal.classList.remove('hidden');
            };

            const closeUserModal = () => {
                userModal.classList.add('hidden');
                userModal.classList.remove('flex');
                userForm.reset();
                userError.classList.add('hidden');
            };

            const render = () => {
                if (state.currentUserRole === 'superadmin') {
                    renderSuperAdminDashboard();
                } else if (state.currentUserRole === 'guru') {
                    renderGuruDashboard();
                } else if (state.currentUserRole === 'siswa') {
                    renderSiswaDashboard();
                } else {
                    renderLogin();
                }
            };


            // =================================================================================
            // SUPABASE HANDLERS (CONTROLLER)
            // =================================================================================
            const handleLogin = async () => {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const role = document.getElementById('roleSelector').value;
                const errorEl = document.getElementById('loginError');

                // Ambil data dari state lokal yang sudah di-load
                const userList = state.users[role] || [];
                const user = userList.find(u => u.username === username);

                // Verifikasi password (Di dunia nyata, ini harus di-hash!)
                if (user && user.password === password) {
                    state.currentUserRole = user.role;
                    state.currentUserName = user.nama;
                    state.currentUserId = user.id;
                    state.selectedSubject = 'Semua'; // Reset tab filter saat login
                    saveState();
                    render();
                    showNotification(`Selamat datang, ${user.nama}!`, 'success');
                } else {
                    errorEl.textContent = 'Username, password, atau peran salah.';
                    errorEl.classList.remove('hidden');
                }
            };

            const handleLogout = () => {
                state.currentUserRole = null;
                state.currentUserName = null;
                state.currentUserId = null;
                state.selectedSubject = 'Semua'; // Reset tab filter saat logout
                saveState();
                render();
            };

            const handleSimpanPenilaian = async (id) => {
                const pengumpulanId = parseInt(id);
                const nilai = document.querySelector(`.nilai-input[data-id="${pengumpulanId}"]`).value;
                const komentarGuru = document.querySelector(`.komentar-input[data-id="${pengumpulanId}"]`).value;
                
                const { data, error } = await supabase
                    .from('pengumpulan')
                    .update({ nilai: parseInt(nilai), komentarGuru: komentarGuru })
                    .eq('id', pengumpulanId);

                if (error) {
                    showNotification(`Gagal menyimpan penilaian: ${error.message}`, 'error');
                } else {
                    // Perbarui state lokal
                    const index = state.pengumpulan.findIndex(p => p.id === pengumpulanId);
                    if (index !== -1) {
                        state.pengumpulan[index].nilai = parseInt(nilai);
                        state.pengumpulan[index].komentarGuru = komentarGuru;
                    }
                    showNotification('Penilaian berhasil disimpan!', 'success');
                    // Tidak perlu re-render, data sudah ada di input
                }
            };
            
            const handleTambahTugas = () => {
                const mataPelajaranOptions = MATA_PELAJARAN_LIST.map(subject => `<option value="${subject}">${subject}</option>`).join('');
                
                const body = `
                    <form id="form-tugas">
                        <div class="mb-4">
                            <label for="judulTugas" class="block mb-1 font-medium">Judul Tugas</label>
                            <input type="text" id="judulTugas" class="w-full p-2 border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="deskripsiTugas" class="block mb-1 font-medium">Deskripsi</label>
                            <textarea id="deskripsiTugas" class="w-full p-2 border rounded-md" rows="4"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="mataPelajaranTugas" class="block mb-1 font-medium">Mata Pelajaran</label>
                            <select id="mataPelajaranTugas" class="w-full p-2 border rounded-md bg-white">
                                ${mataPelajaranOptions}
                            </select>
                        </div>
                        <div>
                            <label for="deadlineTugas" class="block mb-1 font-medium">Deadline</label>
                            <input type="datetime-local" id="deadlineTugas" class="w-full p-2 border rounded-md" required>
                        </div>
                    </form>
                `;
                const footer = `
                    <!-- PERBAIKAN: Mengganti data-action with onclick untuk keandalan -->
                    <button type="button" onclick="closeAppModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                    <button data-action="submit-new-tugas" class="bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700">Simpan</button>
                `;
                showModal({ title: 'Tambah Tugas Baru', body, footer });
                // Set default deadline 1 minggu dari sekarang
                document.getElementById('deadlineTugas').value = toDateTimeLocal(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000));
            };

            const handleSubmitNewTugas = async () => {
                const judul = document.getElementById('judulTugas').value;
                const deskripsi = document.getElementById('deskripsiTugas').value;
                const mata_pelajaran = document.getElementById('mataPelajaranTugas').value;
                const deadline = document.getElementById('deadlineTugas').value;

                if (!judul || !deadline) {
                    showNotification('Judul dan Deadline wajib diisi.', 'error');
                    return;
                }

                const { data, error } = await supabase
                    .from('tugas')
                    .insert([{ judul, deskripsi, mata_pelajaran, deadline: new Date(deadline).toISOString() }])
                    .select(); // .select() untuk mengembalikan data yang baru dimasukkan

                if (error) {
                    showNotification(`Gagal menambah tugas: ${error.message}`, 'error');
                } else if (data) {
                    // Tambahkan ke state lokal
                    state.tugas.push({ ...data[0], deadline: new Date(data[0].deadline) });
                    // Urutkan lagi
                    state.tugas.sort((a, b) => b.deadline - a.deadline);
                    showNotification('Tugas baru berhasil ditambahkan!', 'success');
                    closeModal();
                    render(); // <-- TAMBAHKAN INI untuk me-refresh daftar tugas
                }
            };

            const handleKumpulTugas = (tugasId) => {
                const tugas = state.tugas.find(t => t.id === tugasId);
                const body = `
                    <p class="mb-4">Anda akan mengumpulkan tugas untuk: <strong>${tugas.judul}</strong></p>
                    <form id="form-kumpul">
                        <div>
                            <label for="fileTugas" class="block mb-1 font-medium">Pilih File</label>
                            <input type="file" id="fileTugas" class="w-full p-2 border rounded-md" required>
                            <p class="text-xs text-gray-500 mt-1">Ukuran file maks: 10MB.</p>
                        </div>
                        <div id="upload-progress" class="hidden mt-2 w-full bg-gray-200 rounded-full h-2.5">
                            <div id="upload-progress-bar" class="bg-violet-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </form>
                `;
                const footer = `
                    <!-- PERBAIKAN: Mengganti data-action with onclick untuk keandalan -->
                    <button type="button" onclick="closeAppModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                    <button data-action="submit-kumpul-tugas" data-id="${tugas.id}" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">
                        <i class="fas fa-upload mr-2"></i>Kumpulkan
                    </button>
                `;
                showModal({ title: 'Kumpulkan Tugas', body, footer });
            };
            
            const handleSubmitKumpulTugas = async (tugasId) => {
                const fileInput = document.getElementById('fileTugas');
                const file = fileInput.files[0];
                const tugas = state.tugas.find(t => t.id === tugasId);
                const submitButton = document.querySelector('[data-action="submit-kumpul-tugas"]');
                const progressDiv = document.getElementById('upload-progress');
                const progressBar = document.getElementById('upload-progress-bar');

                if (!file) {
                    showNotification('Anda harus memilih file untuk dikumpulkan.', 'error');
                    return;
                }

                // Unik file path: /<id_siswa>/<id_tugas>-<nama_file>
                const filePath = `${state.currentUserId}/${tugasId}-${file.name}`;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengunggah...';
                progressDiv.classList.remove('hidden');

                // 1. Upload ke Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('file-tugas') // Ganti 'file-tugas' dengan nama bucket Anda
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true, // Timpa jika ada file dengan nama sama
                    });
                
                // Set progress bar ke 100% setelah selesai (Supabase v2 JS tidak ada listener progress)
                progressBar.style.width = '100%';

                if (uploadError) {
                    showNotification(`Gagal mengunggah file: ${uploadError.message}`, 'error');
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-upload mr-2"></i>Kumpulkan';
                    progressDiv.classList.add('hidden');
                    return;
                }

                // 2. Simpan ke database 'pengumpulan'
                const newSubmission = {
                    tugasId: tugasId,
                    siswaId: state.currentUserId,
                    namaSiswa: state.currentUserName,
                    tanggalKumpul: new Date().toISOString(),
                    file_path: uploadData.path,
                    file_name: file.name,
                    file_size: file.size,
                    nilai: null,
                    komentarGuru: null
                };

                const { data: dbData, error: dbError } = await supabase
                    .from('pengumpulan')
                    .insert([newSubmission])
                    .select();

                if (dbError) {
                    showNotification(`Gagal menyimpan data pengumpulan: ${dbError.message}`, 'error');
                    // Coba hapus file yang sudah diupload agar tidak jadi yatim
                    await supabase.storage.from('file-tugas').remove([filePath]);
                } else if (dbData) {
                    // 3. Update state lokal
                    state.pengumpulan.push({
                        ...dbData[0],
                        tanggalKumpul: new Date(dbData[0].tanggalKumpul),
                        file: { name: dbData[0].file_name, size: dbData[0].file_size, path: dbData[0].file_path }
                    });
                    showNotification('Tugas berhasil dikumpulkan!', 'success');
                    closeModal();
                    render(); // Re-render siswa dashboard
                }
            };

            // FUNGSI BARU UNTUK EDIT TUGAS
            const handleEditTugas = (id) => {
                const tugas = state.tugas.find(t => t.id === id);
                if (!tugas) return;

                const mataPelajaranOptions = MATA_PELAJARAN_LIST.map(subject => 
                    `<option value="${subject}" ${tugas.mata_pelajaran === subject ? 'selected' : ''}>${subject}</option>`
                ).join('');

                const body = `
                    <form id="form-edit-tugas">
                        <input type="hidden" id="editTugasId" value="${tugas.id}">
                        <div class="mb-4">
                            <label for="editJudulTugas" class="block mb-1 font-medium">Judul Tugas</label>
                            <input type="text" id="editJudulTugas" class="w-full p-2 border rounded-md" value="${tugas.judul}" required>
                        </div>
                        <div class="mb-4">
                            <label for="editDeskripsiTugas" class="block mb-1 font-medium">Deskripsi</label>
                            <textarea id="editDeskripsiTugas" class="w-full p-2 border rounded-md" rows="4">${tugas.deskripsi}</textarea>
                        </div>
                        <div class="mb-4">
                            <label for="editMataPelajaranTugas" class="block mb-1 font-medium">Mata Pelajaran</label>
                            <select id="editMataPelajaranTugas" class="w-full p-2 border rounded-md bg-white">
                                ${mataPelajaranOptions}
                            </select>
                        </div>
                        <div>
                            <label for="editDeadlineTugas" class="block mb-1 font-medium">Deadline</label>
                            <input type="datetime-local" id="editDeadlineTugas" class="w-full p-2 border rounded-md" value="${toDateTimeLocal(tugas.deadline)}" required>
                        </div>
                    </form>
                `;
                const footer = `
                    <!-- PERBAIKAN: Mengganti data-action with onclick untuk keandalan -->
                    <button type="button" onclick="closeAppModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                    <button data-action="submit-edit-tugas" data-id="${tugas.id}" class="bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700">Simpan Perubahan</button>
                `;
                showModal({ title: 'Edit Tugas', body, footer });
            };

            // FUNGSI BARU UNTUK SUBMIT EDIT TUGAS
            const handleSubmitEditTugas = async (id) => {
                const judul = document.getElementById('editJudulTugas').value;
                const deskripsi = document.getElementById('editDeskripsiTugas').value;
                const mata_pelajaran = document.getElementById('editMataPelajaranTugas').value;
                const deadline = document.getElementById('editDeadlineTugas').value;

                if (!judul || !deadline) {
                    showNotification('Judul dan Deadline wajib diisi.', 'error');
                    return;
                }

                const { data, error } = await supabase
                    .from('tugas')
                    .update({ judul, deskripsi, mata_pelajaran, deadline: new Date(deadline).toISOString() })
                    .eq('id', id)
                    .select();

                if (error) {
                    showNotification(`Gagal memperbarui tugas: ${error.message}`, 'error');
                } else if (data) {
                    // Perbarui state lokal
                    const index = state.tugas.findIndex(t => t.id === id);
                    if (index !== -1) {
                        state.tugas[index] = { ...data[0], deadline: new Date(data[0].deadline) };
                    }
                    // Urutkan lagi
                    state.tugas.sort((a, b) => b.deadline - a.deadline);
                    showNotification('Tugas berhasil diperbarui!', 'success');
                    closeModal();
                    render(); // Refresh dashboard guru
                }
            };

            // FUNGSI BARU UNTUK HAPUS TUGAS
            const handleDeleteTugas = (id, judul) => {
                // PENTING: Cek apakah sudah ada pengumpulan untuk tugas ini
                const hasSubmissions = state.pengumpulan.some(p => p.tugasId === id);
                if (hasSubmissions) {
                    showNotification('Tidak dapat menghapus tugas ini karena sudah ada siswa yang mengumpulkan.', 'error');
                    return;
                }

                // Tampilkan modal konfirmasi
                const body = `<p>Apakah Anda yakin ingin menghapus tugas <strong>"${judul}"</strong>? Tindakan ini tidak dapat dibatalkan.</p>`;
                const footer = `
                    <!-- PERBAIKAN: Mengganti data-action with onclick untuk keandalan -->
                    <button type="button" onclick="closeAppModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                    <button data-action="confirm-delete-tugas" data-id="${id}" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Ya, Hapus</button>
                `;
                showModal({ title: 'Konfirmasi Hapus Tugas', body, footer });
            };

            // FUNGSI BARU UNTUK KONFIRMASI HAPUS TUGAS
            const handleConfirmDeleteTugas = async (id) => {
                const { error } = await supabase
                    .from('tugas')
                    .delete()
                    .eq('id', id);

                if (error) {
                    showNotification(`Gagal menghapus tugas: ${error.message}`, 'error');
                } else {
                    // Hapus dari state lokal
                    state.tugas = state.tugas.filter(t => t.id !== id);
                    showNotification('Tugas berhasil dihapus.', 'success');
                    closeModal();
                    render(); // Refresh dashboard guru
                }
            };

            const handleLihatTugas = async (pengumpulanId) => {
                const pengumpulan = state.pengumpulan.find(p => p.id === pengumpulanId);
                if (!pengumpulan) return;

                // Cek jika file atau path-nya tidak ada
                if (!pengumpulan.file || !pengumpulan.file.path) {
                    console.error('File path is missing for pengumpulan:', pengumpulanId);
                    showNotification('Error: Path file tidak ditemukan.', 'error');
                    return;
                }

                const { data, error } = await supabase.storage
                    .from('file-tugas') // Pastikan nama bucket sama
                    .download(pengumpulan.file.path);

                if (error) {
                    showNotification(`Gagal mengunduh file: ${error.message}`, 'error');
                } else {
                    const url = URL.createObjectURL(data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = pengumpulan.file.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            };

            const handleUserFormSubmit = async (event) => {
                event.preventDefault();
                userError.classList.add('hidden');
                
                const id = parseInt(document.getElementById('user-id').value);
                const nama = document.getElementById('user-nama').value;
                const username = document.getElementById('user-username').value;
                const password = document.getElementById('user-password').value;
                const role = document.getElementById('user-role').value;

                let userData = { nama, username, role };

                if (id) { // Edit mode
                    if (password) {
                        userData.password = password; // (Di dunia nyata, hash ini!)
                    }
                    const { data, error } = await supabase.from('users').update(userData).eq('id', id).select();
                    if (error) {
                        userError.textContent = `Gagal memperbarui pengguna: ${error.message}`;
                        userError.classList.remove('hidden');
                    } else {
                        // Hapus user dari state lokal (dari list manapun dia berada)
                        ['guru', 'siswa'].forEach(r => {
                            const i = state.users[r].findIndex(u => u.id === id);
                            if (i !== -1) state.users[r].splice(i, 1);
                        });
                        // Tambahkan user yang sudah diupdate ke list yang benar
                        state.users[data[0].role].push(data[0]);
                        
                        showNotification('Pengguna berhasil diperbarui.', 'success');
                        closeUserModal();
                        render();
                    }
                } else { // Add mode
                    if (!password) {
                        userError.textContent = 'Password wajib diisi untuk pengguna baru.';
                        userError.classList.remove('hidden');
                        return;
                    }
                    userData.password = password; // (Di dunia nyata, hash ini!)
                    const { data, error } = await supabase.from('users').insert([userData]).select();
                    if (error) {
                        userError.textContent = `Gagal menambah pengguna: ${error.message}`;
                        userError.classList.remove('hidden');
                    } else {
                        // Update local state
                        state.users[data[0].role].push(data[0]);
                        showNotification('Pengguna baru berhasil ditambahkan.', 'success');
                        closeUserModal();
                        render();
                    }
                }
            };
            
            const handleDeleteUser = async (id, nama) => {
                // Ganti window.confirm dengan modal kustom
                const body = `<p>Apakah Anda yakin ingin menghapus pengguna <strong>${nama}</strong>? Tindakan ini tidak dapat dibatalkan.</p>`;
                const footer = `
                    <!-- PERBAIKAN: Mengganti data-action with onclick untuk keandalan -->
                    <button type="button" onclick="closeAppModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                    <button data-action="confirm-delete-user" data-id="${id}" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Ya, Hapus</button>
                `;
                showModal({ title: 'Konfirmasi Hapus', body, footer });
            };

            const handleConfirmDeleteUser = async (id) => {
                const userId = parseInt(id);
                const { data, error } = await supabase.from('users').delete().eq('id', userId);
                if (error) {
                    showNotification(`Gagal menghapus pengguna: ${error.message}`, 'error');
                } else {
                    // Hapus dari state lokal
                    ['guru', 'siswa'].forEach(role => {
                        const index = state.users[role].findIndex(u => u.id === userId);
                        if (index !== -1) {
                            state.users[role].splice(index, 1);
                        }
                    });
                    showNotification('Pengguna berhasil dihapus.', 'success');
                    closeModal();
                    render();
                }
            };


            // =================================================================================
            // EVENT LISTENERS & INITIALIZATION
            // =================================================================================
            
            // Listener untuk form (karena form ada di luar 'appContainer')
            userForm.addEventListener('submit', handleUserFormSubmit);

            // Global click listener untuk 'data-action'
            document.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                const action = target.dataset.action;
                const id = target.dataset.id;

                switch (action) {
                    case 'logout':
                        handleLogout();
                        break;
                    case 'select-subject-tab': // <-- AKSI BARU UNTUK FILTER TAB GURU
                        state.selectedSubject = target.dataset.subject;
                        render(); 
                        break;
                    case 'tambah-tugas':
                        handleTambahTugas();
                        break;
                    case 'kumpul-tugas':
                        handleKumpulTugas(parseInt(id));
                        break;
                    case 'lihat-tugas':
                        handleLihatTugas(parseInt(id));
                        break;
                    case 'simpan-penilaian':
                        handleSimpanPenilaian(parseInt(id));
                        break;
                    
                    /* PERBAIKAN: Menghapus case 'close-modal' karena sekarang 
                       ditangani langsung oleh onclick="closeAppModal()" 
                    */

                    case 'submit-new-tugas':
                        handleSubmitNewTugas();
                        break;
                    case 'submit-kumpul-tugas':
                        handleSubmitKumpulTugas(parseInt(id));
                        break;
                    // --- TAMBAHAN AKSI BARU ---
                    case 'edit-tugas':
                        handleEditTugas(parseInt(id));
                        break;
                    case 'submit-edit-tugas':
                        handleSubmitEditTugas(parseInt(id));
                        break;
                    case 'delete-tugas':
                        const judul = target.dataset.judul;
                        handleDeleteTugas(parseInt(id), judul);
                        break;
                    case 'confirm-delete-tugas':
                        handleConfirmDeleteTugas(parseInt(id));
                        break;
                    // --- AKHIR TAMBAHAN ---
                    case 'add-user':
                        showUserModal();
                        break;
                    case 'edit-user':
                        const allUsers = [...state.users.guru, ...state.users.siswa];
                        const userToEdit = allUsers.find(u => u.id === parseInt(id));
                        if (userToEdit) showUserModal(userToEdit);
                        break;
                    case 'delete-user':
                        const nama = target.dataset.nama;
                        handleDeleteUser(parseInt(id), nama);
                        break;
                    case 'confirm-delete-user':
                        handleConfirmDeleteUser(parseInt(id));
                        break;
                    case 'close-user-modal':
                        closeUserModal();
                        break;
                }
            });


            const init = async () => {
                loadState(); // Memuat sesi (jika ada)
                const dataLoaded = await loadDataFromSupabase(); // Memuat semua data dari DB

                if (dataLoaded) {
                    // Jika data berhasil dimuat, baru cek sesi
                    if (state.currentUserId) {
                        // Verifikasi ulang apakah user masih ada di state (baru di-load)
                        const allUsers = [...state.users.superadmin, ...state.users.guru, ...state.users.siswa];
                        const userExists = allUsers.find(u => u.id === state.currentUserId);
                        if (userExists) {
                            render(); // Render dashboard yang sesuai
                        } else {
                            // Sesi tidak valid (user dihapus), logout
                            handleLogout();
                        }
                    } else {
                        renderLogin(); // Tidak ada sesi, tampilkan login
                    }
                }
                // Jika dataLoaded false, halaman error sudah ditampilkan oleh loadDataFromSupabase
            };

            // Jalankan aplikasi
            init();

        });
    </script>
</body>
</html>
